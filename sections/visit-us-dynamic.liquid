{% comment %}
  Dynamic Store Locator Section
  Displays stores from metaobjects with search, filter, and map
{% endcomment %}

{{ 'visit-us-dynamic.css' | asset_url | stylesheet_tag }}

<section class="visit-us-dynamic">
  <div class="page-width">
    
    {%- comment -%} Search and Filter Bar {%- endcomment -%}
    <div class="store-search-container">
      <div class="search-wrapper">
        <input 
          type="text" 
          id="store-search" 
          class="store-search-input" 
          placeholder="Search by city, address or postcode"
        >
      </div>
      <div class="filter-wrapper">
        <select id="distance-filter" class="distance-filter">
          <option value="10">10 miles</option>
          <option value="20">20 miles</option>
          <option value="30" selected>30 miles</option>
          <option value="50">50 miles</option>
          <option value="100">100 miles</option>
        </select>
      </div>
      <button class="find-stores-btn" id="find-stores-btn">Find stores</button>
    </div>

    {%- comment -%} Results Count {%- endcomment -%}
    <div class="results-count" id="results-count"></div>

    {%- comment -%} Store Locator Layout {%- endcomment -%}
    <div class="store-locator-wrapper">
      
      {%- comment -%} Left Side: Store List {%- endcomment -%}
      <div class="store-list-container">
        <div class="store-list" id="store-list">
          
          {%- assign store_locations = shop.metaobjects.store_location.values -%}
          
          {%- for store in store_locations -%}
            <div class="store-card" 
                 data-store-id="{{ forloop.index }}"
                 data-lat="{{ store.latitude.value }}"
                 data-lng="{{ store.longitude.value }}"
                 data-search="{{ store.store_name.value | downcase }} {{ store.city.value | downcase }} {{ store.address.value | downcase }} {{ store.postcode.value | downcase }}">
              
               <div class="store-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#E57373"/>
                </svg>
              </div> 
              {% comment %} <div class="store-icon">
              <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="32" height="46">
              <path d="M0 0 C3.77004167 1.87689574 6.35555587 4.52195718 8.21484375 8.296875 C10.35889604 14.93201908 9.1261459 21.30098233 6.34765625 27.53515625 C4.47929723 31.09346335 2.48540358 34.54508457 0.375 37.96484375 C-0.19432251 38.9079541 -0.19432251 38.9079541 -0.77514648 39.87011719 C-1.90625 41.62890625 -1.90625 41.62890625 -4.125 44.33984375 C-8.125 44.33984375 -8.125 44.33984375 -10.01953125 42.609375 C-24.43349658 24.14423407 -24.43349658 24.14423407 -23.61328125 11.9375 C-22.65953831 6.86358754 -20.23923023 4.37254494 -16.5625 0.96484375 C-11.19547729 -1.57229426 -5.69869882 -1.77036783 0 0 Z " fill="#E57373" transform="translate(23.125,0.66015625)"/>
              <path d="M0 0 C0.90492187 0.02320313 1.80984375 0.04640625 2.7421875 0.0703125 C4.10730469 0.09738281 4.10730469 0.09738281 5.5 0.125 C6.19867188 0.14820313 6.89734375 0.17140625 7.6171875 0.1953125 C7.6171875 1.8453125 7.6171875 3.4953125 7.6171875 5.1953125 C6.9571875 5.1953125 6.2971875 5.1953125 5.6171875 5.1953125 C5.2871875 4.5353125 4.9571875 3.8753125 4.6171875 3.1953125 C3.6271875 2.8653125 2.6371875 2.5353125 1.6171875 2.1953125 C2.95644874 6.21309622 5.10853219 6.97555098 8.6171875 9.1953125 C9.2771875 9.8553125 9.9371875 10.5153125 10.6171875 11.1953125 C10.4921875 14.1953125 10.4921875 14.1953125 9.6171875 17.1953125 C6.76224775 19.70765948 3.28555716 19.54083038 -0.41015625 19.46484375 C-3.21803378 19.08119316 -5.14229037 17.8757041 -7.3828125 16.1953125 C-7.0528125 14.5453125 -6.7228125 12.8953125 -6.3828125 11.1953125 C-5.3928125 10.8653125 -4.4028125 10.5353125 -3.3828125 10.1953125 C-2.7228125 10.5253125 -2.0628125 10.8553125 -1.3828125 11.1953125 C-1.3828125 12.8453125 -1.3828125 14.4953125 -1.3828125 16.1953125 C0.2671875 16.1953125 1.9171875 16.1953125 3.6171875 16.1953125 C2.45427945 12.70658835 1.47751141 12.09554386 -1.4453125 10.0078125 C-2.54552734 9.21310547 -2.54552734 9.21310547 -3.66796875 8.40234375 C-4.23386719 8.00402344 -4.79976562 7.60570312 -5.3828125 7.1953125 C-4.30239292 0.35265516 -4.30239292 0.35265516 0 0 Z " fill="#FCF5F4" transform="translate(14.3828125,4.8046875)"/>
              <path d="M0 0 C3.465 1.98 3.465 1.98 7 4 C7 5.32 7 6.64 7 8 C5.35 8 3.7 8 2 8 C1 5 1 5 2 2 C1.34 2 0.68 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#E57373" transform="translate(11,14)"/>
              </svg>
              </div>               {% endcomment %}
              <div class="store-info">
                <h3 class="store-name">{{ store.store_name.value }}</h3>
                <p class="store-address">{{ store.address.value }}</p>
                <p class="store-city">{{ store.city.value }}, {{ store.postcode.value }}</p>
                
                <div class="store-hours-preview">
                  <strong>Opening Times</strong>
                  <table class="hours-table-compact">
                    <tr>
                      <td>monday</td>
                      <td>{{ store.monday_hours.value | default: "Closed" }}</td>
                    </tr>
                    <tr>
                      <td>tuesday</td>
                      <td>{{ store.tuesday_hours.value | default: "Closed" }}</td>
                    </tr>
                    <tr>
                      <td>wednesday</td>
                      <td>{{ store.wednesday_hours.value | default: "Closed" }}</td>
                    </tr>
                    <tr>
                      <td>thursday</td>
                      <td>{{ store.thursday_hours.value | default: "Closed" }}</td>
                    </tr>
                    <tr>
                      <td>friday</td>
                      <td>{{ store.friday_hours.value | default: "Closed" }}</td>
                    </tr>
                    <tr>
                      <td>saturday</td>
                      <td>{{ store.saturday_hours.value | default: "Closed" }}</td>
                    </tr>
                    <tr>
                      <td>sunday</td>
                      <td>{{ store.sunday_hours.value | default: "Closed" }}</td>
                    </tr>
                  </table>
                </div>
                
                {%- if store.phone.value != blank -%}
                  <a href="tel:{{ store.phone.value }}" class="store-phone">
                    ðŸ“ž {{ store.phone.value }}
                  </a>
                {%- endif -%}

                {%- if store.models.value != blank -%}
                  <div class="models-compact">
                    <strong>Models</strong>
                    <p>{{ store.models.value }}</p>
                  </div>
                {%- endif -%}

                <a href="https://www.google.com/maps/dir/?api=1&destination={{ store.latitude.value }},{{ store.longitude.value }}" 
                   target="_blank" 
                   class="directions-btn">
                  Go To Store
                </a>
              </div>
            </div>
          {%- endfor -%}
          
        </div>
      </div>

      {%- comment -%} Right Side: Map Only {%- endcomment -%}
      <div class="map-container-wrapper">
        <div class="map-container">
          <div id="store-map"></div>
        </div>
      </div>
      
    </div>

  </div>
</section>
{%- comment -%} Load Leaflet CSS {%- endcomment -%}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

{%- comment -%} Pass store data to JavaScript {%- endcomment -%}
<script>
  window.storeLocations = [
    {%- for store in store_locations -%}
    {
      id: {{ forloop.index }},
      name: {{ store.store_name.value | json }},
      address: {{ store.address.value | json }},
      city: {{ store.city.value | json }},
      postcode: {{ store.postcode.value | json }},
      lat: parseFloat({{ store.latitude.value | json }}),
      lng: parseFloat({{ store.longitude.value | json }}),
      phone: {{ store.phone.value | json }},
      hours: {
        monday: {{ store.monday_hours.value | json }},
        tuesday: {{ store.tuesday_hours.value | json }},
        wednesday: {{ store.wednesday_hours.value | json }},
        thursday: {{ store.thursday_hours.value | json }},
        friday: {{ store.friday_hours.value | json }},
        saturday: {{ store.saturday_hours.value | json }},
        sunday: {{ store.sunday_hours.value | json }}
      },
      models: {{ store.models.value | json }}
    }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ];
</script>

{%- comment -%} Load Leaflet JS and your script {%- endcomment -%}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{{ 'visit-us-dynamic.js' | asset_url }}"></script>

<script>
// Auto-initialize the map when Leaflet is loaded
document.addEventListener('DOMContentLoaded', function() {
  if (typeof L !== 'undefined' && typeof window.createStoreMap === 'function') {
    window.createStoreMap();
  }
});
</script>

{% schema %}
{
  "name": "Visit Us Dynamic",
  "settings": [
    {
      "type": "text",
      "id": "google_maps_api_key",
      "label": "Google Maps API Key",
      "info": "Get your API key from Google Cloud Console"
    }
  ],
  "presets": [
    {
      "name": "Visit Us Dynamic"
    }
  ]
}
{% endschema %}